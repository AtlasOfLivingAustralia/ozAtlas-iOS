

<!DOCTYPE html>
<head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <script src="static/t5OGphSUjwdNOoxNKgdRTTh1RBtmzhMXxHDYYeR4lYj.js" type="text/javascript" ></script>
<link href="static/090onaZX1M508oSWqGmMeETZ9NkUA9p4CCTW3MUpRPc.css" type="text/css" rel="stylesheet" media="screen, projection" />

<link href="static/VySgOjkVOsD8Jt8ujXROVRjZeDLAAwVhMF5WqPZ8Ajf.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="http://www.ala.org.au/wp-content/themes/ala2011/images/favicon.ico" rel="shortcut icon" />
<!--[if lt IE 9]><script src="static/Yh1Txee3hFzExJ4P1str7tGV24zQMEYtxqtlYJ5ukR0.js" type="text/javascript" ></script><![endif]-->
<link href="static/Qwaw257M4sHcJuspEDRbeQoTceByqRmOCHNaZWpOxuc.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="static/AcXIjLTuc87n8sfxBjJRQSoBIUwP9RnCyK8Sv82i7eV.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="static/doSKUivnfI9gXmPKZ2XG4W5xIABYgKaf5Dwf3LtjNVr.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="static/fx5pGfEFSRJi6nyez3s8fUsjDL8WJ0IB04Njm7T2VAJ.css" type="text/css" rel="stylesheet" media="all" />
<link href="static/iHX8x0PqEmsjgyBEeq6NRvjAytsYzmt25tsjtHoHXDq.css" type="text/css" rel="stylesheet" media="screen,print" />




<link href="static/KYGDEVRRaKjNbTXJkHmicmzo9vFrnnzCnGLcxKjR04f.css" type="text/css" rel="stylesheet" media="screen,print" />

<link href="static/exPgH85S7hDuxmySlOZhM0sayvRJla83G3HHYJNzaUB.css" type="text/css" rel="stylesheet" media="screen,print" />
<link href="static/tNjfADEdRvZz6orXSyopLhQhlHwq7bH7hcAZQiGZMoc.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="/static/RrjzrZ0Ci0GPLETIr8x8KUMjfJtZKvifrUtMCedwKRB.png" rel="shortcut icon" />
<link href="static/4zsVqykqBON8U5Es5kfffXBSGJlbI8VrPDW4hSn1SWJ.css" type="text/css" rel="stylesheet" media="screen, projection" />


<link href="static/sCFm7bBsIMFGQHTSlBbhMHQCXWhOsbBr5z4bu1OueIE.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="static/tUELnv7Uvq6ppWNUWOlaow3JGSTTIf8hJ2VYvh7Oahj.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="/static/OKcRcjAeA1yuXD9r4fZA1Uw2HEwL7gYvjc6HdrZXIYP.png" rel="shortcut icon" />
<link href="/static/UxF0saaqmikaj74l2WFcCyPMm9hEEs8if7IBy0GNAnd.png" rel="shortcut icon" />
<link href="/static/zs4hrJqt7I802RlaZiXbmbDBarpNPZF8V8fCQJ2RVTM.png" rel="shortcut icon" />
<link href="/static/SvC1e8bSiCPFh8mObbEThgbJIaGZi72ATzqobK6QnnB.gif" rel="shortcut icon" />
<link href="/static/BA9MhIHZnH0zMcKJWIWsTurHhQTpDYE6akqM5excaZI.gif" rel="shortcut icon" />

<script type="text/javascript">
    var fcConfig = {
        bieUrl: "#",
        speciesProfileUrl: "https://fieldcapture-test.ala.org.au/proxy/speciesProfile",
        googleStaticUrl:"http://maps.googleapis.com/maps/api/staticmap?maptype=terrian&zoom=12&sensor=false&size=350x250&markers=color:red%7C"
        },
        here = document.location.href;
    </script>
    

    <meta name="layout" content="mobile"/>

    
    
    
</if>

    <style type="text/css">
        input[type=checkbox] {  -webkit-transform: scale(1.5); }
        .checkbox-list label { min-height: 40px; }
        .speciesAutocompleteRow {min-height:40px;}
        .datepicker td, .datepicker th {
            width:40px;
            height:40px;
            vertical-align: middle;
        }
    </style>
</head>

<body>

<div id="content" class="clearfix">
    
<div class="container-fluid validationEngineContainer" id="validation-container">
<div id="koActivityMainBlock">

    <div class="row-fluid">
        <div class="span12">
            <!-- Common activity fields -->

            <div class="row-fluid space-after">
                <div class="span4">

                    <label class="for-readonly">Type</label>
                    <span class="readonly-text" data-bind="text:type"></span>
                </div>
                <div class="span8">

                    <label class="for-readonly">Description</label>
                    <span class="readonly-text" data-bind="text:description"></span>
                </div>
            </div>


            <div class="row-fluid space-after">
                <div class="span4">
                    <label class="for-readonly inline">Planned start date</label>
                    <span class="readonly-text" data-bind="text:plannedStartDate.formattedDate"></span>
                </div>
                <div class="span8">
                    <label class="for-readonly inline">Planned end date</label>
                    <span class="readonly-text" data-bind="text:plannedEndDate.formattedDate"></span>
                </div>
            </div>

            <div class="well">
                <div class="row-fluid">

                    <span class="span8">
                    <div class="row-fluid space-after">

                        <div class="span6 required">
                            <label for="startDate"><b>Actual start date</b>
                                <a href='#' class='helphover' data-original-title='Start date' data-placement='top' data-content='Date the activity was started.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a>
                            </label>


                            <div class="input-append">
                                <input data-bind='datepicker:startDate.date' name='startDate' id='startDate' type='text' size='16' class='input-xlarge' readonly='readonly' targetField='startDate.date' data-validation-engine='validate[required]' />
<span class='add-on open-datepicker'>
  <i class='icon-th'>&nbsp;</i>
</span>
                            </div>

                        </div>
                        <div class="span6" data-bind="css:{required:transients.markedAsFinished}">
                            <label for="endDate"><b>Actual end date</b>
                                <a href='#' class='helphover' data-original-title='End date' data-placement='top' data-content='Date the activity finished.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a>
                            </label>

                            <div class="input-append">
                                <input data-bind='datepicker:endDate.date' name='endDate' id='endDate' type='text' size='16' class='input-xlarge' readonly='readonly' targetField='endDate.date' data-validation-engine='validate[future[startDate]]' />
<span class='add-on open-datepicker'>
  <i class='icon-th'>&nbsp;</i>
</span>
                            </div>

                        </div>
                    </div>
                    <div class="row-fluid space-after">
                        <div class="span6">
                            <label for="theme"><b>Major theme</b></label>
                            <select id="theme" data-bind="value:mainTheme, options:transients.themes, optionsCaption:'Choose..'" class="input-xlarge" style="width:90%">
                            </select>
                        </div>

                        <div class="span6">
                            <label><b>Progress</b></label>
                            <label for="activityComplete"><input type="checkbox" id="activityComplete" data-bind="checked:transients.markedAsFinished" style="margin-right:1em;"><span>This activity is complete</span></label>

                        </div>

                    </div>
                    <div class="row-fluid">
                        <div class="span6">
                            <label for="site"><b>Site</b></label>
                            <select id='site' style='width:90%' data-bind='options:transients.sites,optionsText:"name",optionsValue:"siteId",value:siteId,optionsCaption:"Choose a site..."'>&nbsp;</select>

                        </div>

                        <div class="span3">

                            <button class="btn btn-info" style="margin-top:25px;" data-bind="visible:transients.newSiteSupported,click:createNewSite">Create new Site</button>
                        </div>
                    </div>

                    
                        
                            
                                
                            
                            
                                
                                    
                                    
                                    
                                    

                                
                            
                        

                    
                    </span>
                    <span class="span4">

                        <img id="siteLocationImage" width="100%" data-bind="event:{error:siteLoadError}, attr:{src:transients.siteImgUrl}, visible:transients.siteImgUrl()"/>


                    </span>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ko stopBinding: true -->

    
    
    
    <style type="text/css">
        table.auditDoco th {white-space:normal;}
        table.auditDoco tbody td:nth-child(1) {width:70%;}
        table.auditDoco tbody td:nth-child(1)
        table.auditDoco tbody td:nth-child(2) {width:20%;}
        table.auditDoco tbody td:nth-child(2)
        table.auditDoco td:last-child {width:4%;text-align:center;}
        table.auditDoco textarea {width:100%; box-sizing:border-box; }
        table.auditDoco select {width:100%; box-sizing:border-box; }
    </style><style type="text/css">
        table.auditPrePreparedQuestions th {white-space:normal;}
        table.auditPrePreparedQuestions tbody td:nth-child(1) {width:90%;}
        table.auditPrePreparedQuestions tbody td:nth-child(1)
        table.auditPrePreparedQuestions td:last-child {width:4%;text-align:center;}
        table.auditPrePreparedQuestions textarea {width:100%; box-sizing:border-box; }
        table.auditPrePreparedQuestions select {width:100%; box-sizing:border-box; }
    </style>
    <div class="output-block" id="koSite_Visit_Details">
            <h3 data-bind="css:{modified:dirtyFlag.isDirty},attr:{title:'Has been modified'}">Site Visit Details</h3>
        <div data-bind="if:transients.optional">
            <label class="checkbox" ><input type="checkbox" data-bind="checked:outputNotCompleted"> <span data-bind="text:transients.questionText"></span> </label>
        </div>
        <div id="Site_Visit_Details-content" data-bind="visible:!outputNotCompleted()">
        <!-- add the dynamic components -->
            <div class="row-fluid space-after output-section" >
<div class="span6">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Contract Manager:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Enter the name of the Departmental Contract Manager undertaking this review/audit.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input  class="span8 input-small" data-bind='value:data.contractManager'  data-validation-engine='validate[required]' type='text' class='input-small'/></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Site visit date:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Enter the date on which the site visit was undertaken.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><div class="input-append"><input data-bind="datepicker:data.siteVisitDate.date" type="text" size="12" data-validation-engine='validate[required]'/><span class="add-on open-datepicker"><i class="icon-th"></i></span></div></span></div></div><span class="span6">    <span  class="span12">The table below outlines all of the documents you must obtain and assess, plus any other checks required, in conducting your Site Visit. Where required, use the comments box to outline any issues associated with any document or check, including the relevant reference number. Where required, use the comments box to outline any issues associated with any document or check, including the relevant reference number. When you finish a step below you can mark the step as complete by selecting 'Completed' or 'Not completed'.</span></span></div>
<div class="row-fluid space-after " >
<span class="span12">    <span  class="span12"><h3>Site Visit Documents and Checks for Site Visit</h3></span></span></div>
<div class="row-fluid space-after " >
<span class="span12">    <span  class="span12"><h4>Follow-up documentation</h4></span></span></div>
<div class="row-fluid space-after output-section" >
<span class="span3">    <span  class="preLabel required"><label>Are there any documents listed in the Desktop Audit, or other documents you have identified, which are to be obtained from the Service Provider during this Site Visit?:</label></span><select class="span12" data-bind='value:data.auditDocsToBeObtained,options:transients.auditDocsToBeObtainedConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span><span class="span3">    <span  class="span12">If yes, please record the titles of these documents and if they are satisfactory:</span></span><div class="row-fluid ">
            <table class="table table-bordered auditDoco " >
                <thead><tr><th>Document title</th><th>Satisfactory?</th><th></th>
                </tr></thead>
                <tbody data-bind="template:{name:'auditDocoviewTmpl', foreach: data.auditDoco}"></tbody>
                <script id="auditDocoviewTmpl" type="text/html"><tr>
                    <td><select data-bind='value:auditDocTitle,options:transients.auditDocTitleConstraints,optionsCaption:"Please select"'></select></td>
                    <td><select data-bind='value:auditDocAdequacy,options:transients.auditDocAdequacyConstraints,optionsCaption:"Please select"'></select></td>
                    <td><i data-bind='click:$root.removeauditDocoRow' class='icon-remove'></i></td>
                </tr></script>
                <tfoot>
                <tr><td colspan="3" style="text-align:left;">
                        <button type="button" class="btn btn-small" data-bind="click:addauditDocoRow">
                        <i class="icon-plus"></i> Add a row</button></td></tr> <script id="auditDocotemplate-upload" type="text/x-tmpl">{% %}</script>
                       <script id="auditDocotemplate-download" type="text/x-tmpl">{% %}</script>                </tfoot>
            </table>
        </div>
<span class="span3">    <span  class="preLabel"><label>Comments:</label></span><textarea  class="span12" data-bind='value:data.auditCommentsDocuments'></textarea></span></div>
<div class="row-fluid space-after " >
<span class="span12">    <span  class="span12"><h4>Pre-prepared questions</h4>Please insert any significant pre-prepared evaluation questions you intend to ask during the Site Visit. Please use the comments section to reflect on the responses you are able to obtain.</span></span></div>
<div class="row-fluid space-after output-section" >
<div class="row-fluid ">
            <table class="table table-bordered auditPrePreparedQuestions " >
                <thead><tr><th>Pre-prepared Questions</th><th></th>
                </tr></thead>
                <tbody data-bind="template:{name:'auditPrePreparedQuestionsviewTmpl', foreach: data.auditPrePreparedQuestions}"></tbody>
                <script id="auditPrePreparedQuestionsviewTmpl" type="text/html"><tr>
                    <td><textarea  data-bind='value:prePreparedQuestions'></textarea></td>
                    <td><i data-bind='click:$root.removeauditPrePreparedQuestionsRow' class='icon-remove'></i></td>
                </tr></script>
                <tfoot>
                <tr><td colspan="2" style="text-align:left;">
                        <button type="button" class="btn btn-small" data-bind="click:addauditPrePreparedQuestionsRow">
                        <i class="icon-plus"></i> Add a row</button></td></tr> <script id="auditPrePreparedQuestionstemplate-upload" type="text/x-tmpl">{% %}</script>
                       <script id="auditPrePreparedQuestionstemplate-download" type="text/x-tmpl">{% %}</script>                </tfoot>
            </table>
        </div>
<span class="span6">    <span  class="preLabel"><label>Comments:</label></span><textarea  class="span12" data-bind='value:data.auditCommentsPrePrepQuestions'></textarea></span></div>
<div class="row-fluid space-after " >
<span class="span12">    <span  class="span12"><h4>Observations on site</h4>Ensure that you see and inspect the relevant on-ground works and activities, and get the opportunity to discuss the Project activities and your observations with the Service Provider or Project Sponsor’s and all relevant stakeholders.</span></span></div>
<div class="row-fluid space-after output-section" >
<div class="span12">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Is there an adequate number of Participants in attendance at the time of the site visit?:</label></span><select class="span8" data-bind='value:data.auditParticipantRepresentation,options:transients.auditParticipantRepresentationConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Is there communications equipment available and being used on site?:</label></span><select class="span8" data-bind='value:data.auditCommsEquipment,options:transients.auditCommsEquipmentConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Has personal protective equipment for each Participant (such as steel-capped work boots, board-brimmed hat, heavy duty long trousers, work gloves and long sleeved shirt) been supplied and is it being worn?:</label></span><select class="span8" data-bind='value:data.auditPPE,options:transients.auditPPEConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Has other equipment, including Project Specific Materials (such as hard hats, hearing protection, eye protection, sun protection, insect repellent , wet weather protection, warm jumpers and/or jackets for cold climates) been supplied and are they visible (or being worn appropriately) on site?:</label></span><select class="span8" data-bind='value:data.auditProjectEquipment,options:transients.auditProjectEquipmentConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Are First Aid kits accessible?:</label></span><select class="span8" data-bind='value:data.auditFirstAidKits,options:transients.auditFirstAidKitsConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Do vehicles appear to be safe and in good working order?:</label></span><select class="span8" data-bind='value:data.auditVehicleSafety,options:transients.auditVehicleSafetyConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Is the Participant and Team Supervisor ratio correct (max 9:1)?:</label></span><select class="span8" data-bind='value:data.auditTeamRatio,options:transients.auditTeamRatioConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel"><label>Comments:</label></span><textarea  class="span8" data-bind='value:data.auditCommentsObservations'></textarea></span></div></div></div>
<div class="row-fluid space-after " >
<span class="span12">    <span  class="span12"><h4>Post Site Visit</h4></span></span></div>
<div class="row-fluid space-after output-section" >
<div class="span12">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Have you saved all documents in the relevant Service Provider record in SPIRE?:</label></span><select class="span8" data-bind='value:data.auditDocsInSpire,options:transients.auditDocsInSpireConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div></div></div>
<div class="row-fluid space-after " >
<span class="span12">    <span  class="span12">Please note that, upon completion of the Site Visit, you must complete the Project Audit Report and arrange for Director sign off and contact the Service Provider (by email) to advise of the Audit outcomes and any actions required.</span></span></div>

        </div>
        
    </div>
    

<!-- /ko -->

</div>




</div>

<script src="static/Zbj0J8XhmZDqWqIAz5C46TWLOULGl7LNvdJeBlO9fMb.js" type="text/javascript" ></script>





<script src="static/5zeDycYZFxJsfDd3W1kuhrN47XnIMrbhS6gdHDvcExv.js" type="text/javascript" ></script>

<script src="static/ulxBmo4RrKTNT3DuFHethb4EOZpwQfvefxNXivDIbzp.js" type="text/javascript" ></script>








<!--[if gte IE 8]><script src="static/knxjs4G9Cquc79O3iYW107XikPB1Z1ii8QWrtBpzlSP.js" type="text/javascript" ></script><![endif]-->
<script src="static/nRrltgvxdEHd5BqRR1v4XU3ZStOrhDScuH03g4r8E6O.js" type="text/javascript" ></script>

<script src="static/zP22SFJVnKXoWuBJdbsNhcivH2iXiC57wEOHXSDNudf.js" type="text/javascript" ></script>

<script src="static/QjmKsgTA1QWYxF0gcpdSFROG8mBnzaabMZcvDxBb9Xo.js" type="text/javascript" ></script>






<script src="static/IZCc6ZgD3MepYbz4UqlDLzMDNNghSCivcfGebmF9V2d.js" type="text/javascript" ></script>
<script src="static/I4NiLd8qMXMMgs4hAqHb5YT0jGlQhM4Yp0dku4W1Wng.js" type="text/javascript" ></script>



<script src="static/e9gGniNN5cG3OR4oPVWd5lYoxE5Xf282hFe7d4FTQbq.js" type="text/javascript" ></script>


<script src="static/CRNxISj7t7ZCV7B8M8dFtBK7x7R4tGVO36INoBz8gQX.js" type="text/javascript" ></script>

<script src="static/QhlSgFWjl35vcaCRa5cKxHZxRWSSluzptQUKz3PHr9s.js" type="text/javascript" ></script>


<script src="static/8WCQyXwicnBgTdLQ4F5jUFtmVXmqG9eUZKvo74wOnIT.js" type="text/javascript" ></script>
<script src="static/9HtLc6nfgO9H72LVVZxetW45ZR623Fx8EhEdydgOq2F.js" type="text/javascript" ></script>
<script src="static/wkrwT3eqoZlWXFPCQRTvkdsdvwzT5Lw2H89f9eTkQdb.js" type="text/javascript" ></script>


<script type="text/javascript">
        $(function(){

            var viewModelName = "Site_Visit_DetailsViewModel",
                viewModelInstance = viewModelName + "Instance";

            // load dynamic models - usually objects in a list
                    var AuditDocoRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.auditDocTitle = ko.observable(orBlank(data['auditDocTitle']));
            this.auditDocAdequacy = ko.observable(orBlank(data['auditDocAdequacy']));
            self.transients.auditDocAdequacyConstraints = ["Yes","No"];
        };
        var AuditPrePreparedQuestionsRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.prePreparedQuestions = ko.observable(orBlank(data['prePreparedQuestions']));
        };
        var speciesLists = [];
        var site = {};


            this[viewModelName] = function (output, config) {
                var self = this;
                self.name = "Site Visit Details";
                self.outputId = orBlank(output.outputId);

                self.data = {};
                self.transients = {};
                var notCompleted = output.outputNotCompleted;

                if (notCompleted === undefined) {
                    notCompleted = config.collapsedByDefault;
                }
                self.outputNotCompleted = ko.observable(notCompleted);
                self.transients.optional = config.optional || false;
                self.transients.questionText = config.optionalQuestionText || 'Not applicable';
                self.transients.dummy = ko.observable();

                // add declarations for dynamic data
                
            self.data.contractManager = ko.observable();

            self.data.siteVisitDate = ko.observable().extend({simpleDate: false});

            self.data.auditDocsToBeObtained = ko.observable();
            self.transients.auditDocsToBeObtainedConstraints = ["Yes","No"];

            self.data.auditDoco = ko.observableArray([]);
            self.selectedauditDocoRow = ko.observable();
        

            self.loadauditDoco = function (data, append) {
                if (!append) {
                    self.data.auditDoco([]);
                }
                if (data === undefined) {
                    self.addauditDocoRow();
                } else {
                    $.each(data, function (i, obj) {
                        self.data.auditDoco.push(new AuditDocoRow(obj));
                    });
                }
            };

            self.addauditDocoRow = function () {
                var newRow = new AuditDocoRow();
                self.data.auditDoco.push(newRow);
                
            };
            self.removeauditDocoRow = function (row) {
                self.data.auditDoco.remove(row);
                
            };
            self.auditDocorowCount = function () {
                return self.data.auditDoco().length;
            };

            self.auditDocoTableDataUploadVisible = ko.observable(false);
            self.showauditDocoTableDataUpload = function() {
                self.auditDocoTableDataUploadVisible(!self.auditDocoTableDataUploadVisible());
            };

            self.auditDocoTableDataUploadOptions = {
                    url:'/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadauditDoco(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "auditDocotemplate-upload",
                    downloadTemplateId: "auditDocotemplate-download",
                    formData:{type:'Site Visit Details', listName:'auditDoco'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };

            self.data.auditCommentsDocuments = ko.observable();

            self.data.auditPrePreparedQuestions = ko.observableArray([]);
            self.selectedauditPrePreparedQuestionsRow = ko.observable();
        

            self.loadauditPrePreparedQuestions = function (data, append) {
                if (!append) {
                    self.data.auditPrePreparedQuestions([]);
                }
                if (data === undefined) {
                    self.addauditPrePreparedQuestionsRow();
                } else {
                    $.each(data, function (i, obj) {
                        self.data.auditPrePreparedQuestions.push(new AuditPrePreparedQuestionsRow(obj));
                    });
                }
            };

            self.addauditPrePreparedQuestionsRow = function () {
                var newRow = new AuditPrePreparedQuestionsRow();
                self.data.auditPrePreparedQuestions.push(newRow);
                
            };
            self.removeauditPrePreparedQuestionsRow = function (row) {
                self.data.auditPrePreparedQuestions.remove(row);
                
            };
            self.auditPrePreparedQuestionsrowCount = function () {
                return self.data.auditPrePreparedQuestions().length;
            };

            self.auditPrePreparedQuestionsTableDataUploadVisible = ko.observable(false);
            self.showauditPrePreparedQuestionsTableDataUpload = function() {
                self.auditPrePreparedQuestionsTableDataUploadVisible(!self.auditPrePreparedQuestionsTableDataUploadVisible());
            };

            self.auditPrePreparedQuestionsTableDataUploadOptions = {
                    url:'/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadauditPrePreparedQuestions(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "auditPrePreparedQuestionstemplate-upload",
                    downloadTemplateId: "auditPrePreparedQuestionstemplate-download",
                    formData:{type:'Site Visit Details', listName:'auditPrePreparedQuestions'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };

            self.data.auditCommentsPrePrepQuestions = ko.observable();

            self.data.auditParticipantRepresentation = ko.observable();
            self.transients.auditParticipantRepresentationConstraints = ["Yes","No"];

            self.data.auditCommsEquipment = ko.observable();
            self.transients.auditCommsEquipmentConstraints = ["Yes","No"];

            self.data.auditPPE = ko.observable();
            self.transients.auditPPEConstraints = ["Yes","No"];

            self.data.auditProjectEquipment = ko.observable();
            self.transients.auditProjectEquipmentConstraints = ["Yes","No"];

            self.data.auditFirstAidKits = ko.observable();
            self.transients.auditFirstAidKitsConstraints = ["Yes","No"];

            self.data.auditVehicleSafety = ko.observable();
            self.transients.auditVehicleSafetyConstraints = ["Yes","No"];

            self.data.auditTeamRatio = ko.observable();
            self.transients.auditTeamRatioConstraints = ["Yes","No"];

            self.data.auditCommentsObservations = ko.observable();

            self.data.auditDocsInSpire = ko.observable();
            self.transients.auditDocsInSpireConstraints = ["Yes","No"];
            self.transients.site = site;

                // this will be called when generating a savable model to remove transient properties
                self.removeBeforeSave = function (jsData) {
                    // add code to remove any transients added by the dynamic tags
                    
                    delete jsData.activityType;
                    delete jsData.transients;
                    return jsData;
                };

                // this returns a JS object ready for saving
                self.modelForSaving = function () {
                    // get model as a plain javascript object
                    var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
                    if (self.outputNotCompleted()) {
                        jsData.data = {};
                    }
                    // get rid of any transient observables
                    return self.removeBeforeSave(jsData);
                };

                // this is a version of toJSON that just returns the model as it will be saved
                // it is used for detecting when the model is modified (in a way that should invoke a save)
                // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
                self.modelAsJSON = function () {
                    return JSON.stringify(self.modelForSaving());
                };

                self.loadData = function (data) {
                    // load dynamic data
                                    self.data['contractManager'](data['contractManager']);
                self.data['siteVisitDate'](data['siteVisitDate']);
                self.data['auditDocsToBeObtained'](data['auditDocsToBeObtained']);
                self.loadauditDoco(data.auditDoco);
                self.data['auditCommentsDocuments'](data['auditCommentsDocuments']);
                self.loadauditPrePreparedQuestions(data.auditPrePreparedQuestions);
                self.data['auditCommentsPrePrepQuestions'](data['auditCommentsPrePrepQuestions']);
                self.data['auditParticipantRepresentation'](data['auditParticipantRepresentation']);
                self.data['auditCommsEquipment'](data['auditCommsEquipment']);
                self.data['auditPPE'](data['auditPPE']);
                self.data['auditProjectEquipment'](data['auditProjectEquipment']);
                self.data['auditFirstAidKits'](data['auditFirstAidKits']);
                self.data['auditVehicleSafety'](data['auditVehicleSafety']);
                self.data['auditTeamRatio'](data['auditTeamRatio']);
                self.data['auditCommentsObservations'](data['auditCommentsObservations']);
                self.data['auditDocsInSpire'](data['auditDocsInSpire']);


                    // if there is no data in tables then add an empty row for the user to add data
                    if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                        self.addRow();
                    }
                    self.transients.dummy.notifySubscribers();
                };
            };


            var savedData = activity;
            if (!savedData.outputs) {
                savedData.outputs = [];
            }
            var savedOutput = {};
            if (savedData) {

                $.each(savedData.outputs, function(i, tmpOutput) {
                    if (tmpOutput.name === 'Site Visit Details') {
                        savedOutput = tmpOutput;
                    }
                });
            }

            var config = JSON.parse('\u007b\u007d');
            window[viewModelInstance] = new this[viewModelName](savedOutput, config);
            var output = savedOutput.data ? savedOutput.data : {};

            window[viewModelInstance].loadData(output);
            window[viewModelInstance].dirtyFlag = ko.dirtyFlag(window[viewModelInstance], false);

            ko.applyBindings(window[viewModelInstance], document.getElementById("koSite_Visit_Details"));

            // this resets the baseline for detecting changes to the model
            // - shouldn't be required if everything behaves itself but acts as a backup for
            //   any binding side-effects
            // - note that it is not foolproof as applying the bindings happens asynchronously and there
            //   is no easy way to detect its completion
            window[viewModelInstance].dirtyFlag.reset();

            // register with the master controller so this model can participate in the save cycle
            master.register(window[viewModelInstance], window[viewModelInstance].modelForSaving,
            window[viewModelInstance].dirtyFlag.isDirty, window[viewModelInstance].dirtyFlag.reset);
        });

        </script><script type="text/javascript">


    /* Master controller for page. This handles saving each model as required. */
    var Master = function () {
        var self = this;
        this.subscribers = [];
        // client models register their name and methods to participate in saving
        self.register = function (modelInstanceName, getMethod, isDirtyMethod, resetMethod) {
            this.subscribers.push({
                model: modelInstanceName,
                get: getMethod,
                isDirty: isDirtyMethod,
                reset: resetMethod
            });
        };
        // master isDirty flag for the whole page - can control button enabling
        this.isDirty  = function () {
            var dirty = false;
            $.each(this.subscribers, function(i, obj) {
                dirty = dirty || obj.isDirty();
            });
            return dirty;
        };

        this.validate = function() {
            var valid = $('#validation-container').validationEngine('validate');
            if (valid) {
                // Check that forms with multiple optional sections have at least one of those sections completed.
                var optionalCount = 0;
                var notCompletedCount = 0;
                $.each(self.subscribers, function(i, obj) {
                    if (obj.model !== 'activityModel' && obj.model !== 'photoPoints') {
                        if (obj.model.transients.optional) {
                            optionalCount++;
                            if (obj.model.outputNotCompleted()) {
                                notCompletedCount++;
                            }
                        }
                    }
                });
                if (optionalCount > 1 && notCompletedCount == optionalCount) {
                   valid = false;
                   bootbox.alert("<p>To 'Save changes', the mandatory fields of at least one section of this form must be completed.</p>"+
                        "<p>If all sections are 'Not applicable' please contact your grant manager to discuss alternate form options</p>");
                }
            }

            return valid;
        };
        /**
         * Makes an ajax call to save any sections that have been modified. This includes the activity
         * itself and each output.
         *
         * Modified outputs are injected as a list into the activity object. If there is nothing to save
         * in the activity itself, then the root is an object that is empty except for the outputs list.
         *
         * NOTE that the model for each section must register itself to be included in this save.
         *
         * Validates the entire page before saving.
         * @return -1 if the page was not modified, 0 if validation failed, 1 if validation succeeded (or was not requested).
         */
        this.save = function (validate) {
            // Ensure any active change is committed - the knockout binding typically fires on blur.
            $( document.activeElement ).blur();

            if (validate === undefined) {
                validate = true;
            }
            var activityData, outputs = [];

            var success = true;
            if (validate) {
                success = self.validate();
            }
            if (!self.isDirty()) {
                mobileBindings.onSaveActivity(-1, null);
                return -1;
            }
            if (success) {
                $.each(this.subscribers, function(i, obj) {
                    if (obj.model === 'activityModel') {
                        activityData = obj.get();
                    } else {
                        outputs.push(obj.get());
                    }
                });

                if (activityData === undefined) { activityData = {}}
                activityData.outputs = outputs;

                var toSave = JSON.stringify(activityData);
                mobileBindings.onSaveActivity(1, toSave);

            }
            else {
                mobileBindings.onSaveActivity(0, null);
            }
            return success?1:0;
        };

        this.reset = function () {
            $.each(this.subscribers, function(i, obj) {
                if (obj.isDirty()) {
                    obj.reset();
                }
            });
        };

        this.addSite = function(site) {
            var viewModel = ko.dataFor(document.getElementById('site'));
            viewModel.transients.sites.push(site);
            viewModel.siteId(site.siteId);
        }
    };

    if (mobileBindings == undefined) {
        var mobileBindings = {
        
            loadActivity:function(){return "{}"},
        
        
            loadSites:function(){return "[]"},
        
        
            loadThemes:function(){return "[]"},
        

        supportsNewSite:function() { return true; },
        onSaveActivity:function(){},
        createNewSite:function(){}
    };
}
var master = new Master();
var activity = JSON.parse(mobileBindings.loadActivity());
var sites = JSON.parse(mobileBindings.loadSites());
var themes = JSON.parse(mobileBindings.loadThemes());

$(function(){

var scroll = false;

$('#validation-container').validationEngine('attach', {scroll: scroll});

$('.helphover').popover({animation: true, trigger:'hover'});

$('#reset').click(function () {
master.reset();
});

function ViewModel (act, sites, themes) {
var self = this;
var today = new Date().toISOStringNoMillis();

self.activityId = act.activityId;
self.description = ko.observable(act.description);
self.notes = ko.observable(act.notes);
self.startDate = ko.observable(act.startDate || today).extend({simpleDate: false});
self.endDate = ko.observable(act.endDate).extend({simpleDate: false});
self.plannedStartDate = ko.observable(act.plannedStartDate).extend({simpleDate: false});
self.plannedEndDate = ko.observable(act.plannedEndDate).extend({simpleDate: false});
self.eventPurpose = ko.observable(act.eventPurpose);
self.fieldNotes = ko.observable(act.fieldNotes);
self.associatedProgram = ko.observable(act.associatedProgram);
self.associatedSubProgram = ko.observable(act.associatedSubProgram);
self.progress = ko.observable(act.progress);
self.mainTheme = ko.observable(act.mainTheme);
self.type = ko.observable(act.type);
self.siteId = ko.observable(act.siteId);
self.projectId = act.projectId;
self.transients = {};
self.transients.sites = ko.observableArray(sites);
self.transients.photoPoints = ko.computed(function() {
    var site = $.grep(self.transients.sites(), function(site, index) { return site.siteId == self.siteId(); })[0];
     if (site) {
         return site.photoPoints ? site.photoPoints : site.poi;
     }
     return [];
});
self.transients.activityProgressValues = ['planned','started','finished'];
self.transients.themes = themes?themes:[];
self.transients.markedAsFinished = ko.observable(act.progress === 'finished');
self.transients.markedAsFinished.subscribe(function (finished) {
    self.progress(finished ? 'finished' : 'started');
    if (finished || !self.endDate()) {
        self.endDate(today);
    }
});
self.transients.siteImgUrl = ko.computed(function() {
    if (self.siteId()) {
         var site = $.grep(self.transients.sites(), function(site, index) { return site.siteId == self.siteId(); })[0];
         if (site) {
            var lat,lon;
            if (site.centroidLat !== undefined && site.centroidLon !== undefined) {
                lat = site.centroidLat;
                lon = site.centroidLon;
            }
            else if (site.extent && site.extent.geometry && site.extent.geometry.centre) {
                lat = site.extent.geometry.centre[1];
                lon = site.extent.geometry.centre[0];
            }
            if (lat !== undefined && lon !== undefined) {
                $('#siteLocationImage').show();
                return fcConfig.googleStaticUrl+lat+","+lon;
            }
         }
    }
    return "";
});
self.siteLoadError = function(data, event) {
    $('#siteLocationImage').hide();
};

self.transients.newSiteSupported = ko.observable( mobileBindings.supportsNewSite());

self.modelForSaving = function () {
    // get model as a plain javascript object
    var jsData = ko.toJS(self);
    delete jsData.transients;
    return jsData;
};
self.modelAsJSON = function () {
    return JSON.stringify(self.modelForSaving());
};

self.save = function (callback, key) {
};

self.createNewSite = function() {
    mobileBindings.createNewSite();
}

self.notImplemented = function () {
    alert("Not implemented yet.")
};

self.attachPhotoPoint = function(e) {
    console.log(e);
};
self.dirtyFlag = ko.dirtyFlag(self, false);

// make sure progress moves to started if we save any data (unless already finished)
// (do this here so the model becomes dirty)
self.progress(self.transients.markedAsFinished() ? 'finished' : 'started');
}


var viewModel = new ViewModel(activity, sites, themes);

ko.applyBindings(viewModel);

master.register('activityModel', viewModel.modelForSaving, viewModel.dirtyFlag.isDirty, viewModel.dirtyFlag.reset);


});


</script>
</body>
</html>